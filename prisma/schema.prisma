// ============================================================
// Compile-n-Conquer â€” Prisma Schema
// ============================================================

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ---- Users ----

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  email        String   @unique
  passwordHash String
  displayName  String?
  avatarUrl    String?
  title        String    @default("Code Warrior")
  skillTier    SkillTier @default(BEGINNER)
  elo          Int       @default(1000)
  totalWins    Int       @default(0)
  totalMatches Int       @default(0)
  totalXP      Int       @default(0)
  streak       Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  matchPlayers  MatchPlayer[]
  queueEntries  QueueEntry[]

  @@map("users")
}

enum SkillTier {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  PRO
}

// ---- Matchmaking Queue ----

model QueueEntry {
  id        String   @id @default(cuid())
  userId    String
  joinedAt  DateTime @default(now())
  active    Boolean  @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, active])
  @@map("queue_entries")
}

// ---- Matches ----

model Match {
  id          String      @id @default(cuid())
  maxPlayers  Int         @default(3)
  status      MatchStatus @default(WAITING)
  mode        GameMode    @default(FASTEST)
  startedAt   DateTime?
  endedAt     DateTime?
  createdAt   DateTime    @default(now())

  // Backboard thread IDs for evaluation
  threadTimeComplexity  String?
  threadSpaceComplexity String?
  threadOriginality     String?
  threadRanking         String?

  // Relations
  players     MatchPlayer[]
  questions   MatchQuestion[]
  submissions Submission[]

  @@map("matches")
}

enum MatchStatus {
  WAITING      // Waiting for all players to connect
  IN_PROGRESS  // Match is live
  EVALUATING   // Code submitted, LLM evaluation running
  COMPLETED    // Results are in
  CANCELLED
}

enum GameMode {
  FASTEST        // First to pass all test cases
  SHORTEST       // Shortest code (by chars) that passes
  REVERSE        // Given output, write the code that produces it
  DEBUGGING      // Fix broken code
}

enum MatchOutcome {
  WIN
  LOSS
  DRAW
}

model MatchPlayer {
  id        String   @id @default(cuid())
  matchId   String
  userId    String
  rank      Int?     // Final rank after evaluation
  score     Float?   // Final weighted score
  result    MatchOutcome?
  xpDelta   Int      @default(0)
  joinedAt  DateTime @default(now())

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([matchId, userId])
  @@map("match_players")
}

// ---- Questions ----

model Question {
  id          String     @id @default(cuid())
  title       String
  description String
  difficulty  Difficulty @default(MEDIUM)
  mode        GameMode   @default(FASTEST)

  // For DEBUGGING mode: the broken code to fix
  brokenCode     String?
  brokenLanguage String?

  // For REVERSE mode: expected output
  expectedOutput String?

  // Test cases stored as JSON
  testCases  Json?    // [{ input: string, expectedOutput: string }]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  matchQuestions MatchQuestion[]

  @@map("questions")
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

model MatchQuestion {
  id         String @id @default(cuid())
  matchId    String
  questionId String
  order      Int    @default(0) // Question order in the match

  match    Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([matchId, questionId])
  @@map("match_questions")
}

// ---- Submissions ----

model Submission {
  id         String   @id @default(cuid())
  matchId    String
  userId     String
  questionId String
  code       String
  language   String
  charCount  Int?     // For SHORTEST mode

  // Piston execution results
  stdout       String?
  stderr       String?
  exitCode     Int?
  execTimeMs   Int?
  testsPassed  Int     @default(0)
  testsTotal   Int     @default(0)

  // LLM evaluation scores
  timeComplexity  String?  // e.g. "O(n)"
  timeScore       Float?
  spaceComplexity String?
  spaceScore      Float?
  originalityScore Float?
  relevanceScore   Float?

  submittedAt DateTime @default(now())

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@map("submissions")
}
